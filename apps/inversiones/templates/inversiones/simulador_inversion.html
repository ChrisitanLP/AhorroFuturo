{% extends 'base_page.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Simulador de Inversión | Ahorro Futuro{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'styles/inversion.css' %}">
{% endblock %}

{% block content %}
<section class="simulador-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-7 simulador-content">
                <h1 class="simulador-title"><span style="color: var(--pichincha-blue);">Simulador de Inversión</span></h1>
                <p class="simulador-subtitle">Rentabiliza tu dinero con una inversión a una tasa de interés conveniente.</p>
            </div>
            <div class="col-lg-5 d-none d-lg-block">
                <div class="simulador_ilustracion">
                    <img src="{% static 'assets/img/Banners/simulador_banner.png' %}" alt="Ilustracion">
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container my-5">
    <div class="stepper-wrapper mb-4" id="investment-stepper">
        <div class="stepper-item active" data-step="1">
            <span class="step-counter">1</span>
            <div class="step-name">Seleccionar inversión</div>
        </div>
        <div class="stepper-item" data-step="2">
            <span class="step-counter">2</span>
            <div class="step-name">Detalles</div>
        </div>
        <div class="stepper-item" data-step="3">
            <span class="step-counter">3</span>
            <div class="step-name">Resultados</div>
        </div>
    </div>
</div>

<div class="container my-5">
    <h1 class="text-center mb-4 detalle_credito-title">¿Qué tipo de inversión te interesa?</h1>
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Tarjeta principal -->
            <div class="card shadow">
                <div class="card-body">
                    <!-- Stepper de pasos -->

                    <!-- Formulario de simulación -->
                    <form id="formulario-simulador-inversion">
                        <!-- Paso 1: Selección de tipo de inversión -->
                        <div class="step-content active" id="step-1">
                            <div class="row justify-content-center">
                                {% for tipo in tipos_inversion %}
                                <div class="col-md-4 mb-4">
                                    <div class="card tipo-inversion-card" data-id="{{ tipo.id }}">
                                        <div class="card-body text-center">
                                            <div class="risk-indicator risk-{{ tipo.riesgo|lower }}">
                                                <span>Riesgo {{ tipo.riesgo|title }}</span>
                                            </div>
                                            <h5 class="card-title">{{ tipo.nombre }}</h5>
                                            <p class="rentabilidad">
                                                <span class="porcentaje">{{ tipo.rentabilidad_anual_minima }}% - {{ tipo.rentabilidad_anual_maxima }}%</span>
                                                <span class="periodo">anual</span>
                                            </p>
                                            <p class="card-text small">{{ tipo.descripcion|truncatechars:100 }}</p>
                                            <hr>
                                            <div class="caracteristicas small">
                                                <div class="row">
                                                    <div class="col-6 text-start">Plazo mínimo:</div>
                                                    <div class="col-6 text-end">{{ tipo.plazo_minimo }} meses</div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-6 text-start">Monto mínimo:</div>
                                                    <div class="col-6 text-end">${{ tipo.monto_minimo }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-yellow btn-continue" data-next="2" disabled>Continuar</button>
                            </div>
                        </div>
                        
                        <!-- Paso 2: Configuración de la inversión -->
                        <div class="step-content" id="step-2">
                            <div class="row">
                                <div class="col-md-12 text-center mb-4">
                                    <h3>Configura tu inversión</h3>
                                    <h5 id="tipo-inversion-seleccionado" class=""></h5>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 inversion-form-section">
                                    <div class="form-group mb-4">
                                        <label for="monto_inversion">¿Cuánto dinero quieres invertir?</label>
                                        <input type="text" id="monto_inversion" name="monto_inversion" class="form-control numero-formato" placeholder="Ej: $5000">
                                        <small class="form-text text-muted" id="rango_monto">Rango: $0 - $0</small>
                                    </div>
                                    
                                    <div class="form-group mb-4">
                                        <label for="plazo">¿Por cuánto tiempo deseas invertir?</label>
                                        <select id="plazo" name="plazo" class="form-control form-select">
                                            <option value="" disabled selected>Selecciona el plazo</option>
                                        </select>
                                        <small class="form-text text-muted" id="rango_plazo">Rango: 0 - 0 meses</small>
                                    </div>
                                    
                                    <div class="form-group mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="reinversion_intereses" name="reinversion_intereses">
                                            <label class="form-check-label" for="reinversion_intereses">
                                                Reinvertir intereses (capitalización)
                                            </label>
                                        </div>
                                        <small class="form-text text-muted text-italic">Los intereses generados se reinvierten para generar más rendimientos</small>
                                    </div>
                                    
                                    <div class="extra-infor-inversion">
                                        <div class="info-rentabilidad mb-4">
                                            <h5>Rentabilidad estimada</h5>
                                            <div class="rentabilidad-range-container">
                                                <div class="rentabilidad-range">
                                                    <div class="rentabilidad-fill" id="rentabilidad-fill"></div>
                                                </div>
                                                <div class="rentabilidad-labels">
                                                    <span id="rentabilidad-min">0%</span>
                                                    <span id="rentabilidad-max">0%</span>
                                                </div>
                                            </div>
                                            <p class="small text-muted mt-2">La rentabilidad final dependerá de las condiciones del mercado al momento de invertir.</p>
                                        </div>
                                        <hr>
                                        <div class="form-group mb-4">
                                            <div class="risk-explanation">
                                                <h5>Nivel de riesgo: <span id="nivel-riesgo">-</span></h5>
                                                <div class="risk-meter">
                                                    <div class="risk-level" id="risk-level"></div>
                                                </div>
                                                <p class="small text-muted mt-2" id="risk-description"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card inversion-preview">
                                        <div class="card-body">
                                            <h5 class="card-title mb-4">Previsualización</h5>
                                            <hr>
                                            <div class="preview-chart-container">
                                                <canvas id="previewChart"></canvas>
                                            </div>
                                            
                                            <div class="inversion-resumen mt-4">
                                                <div class="row">
                                                    <div class="col-7">Capital inicial:</div>
                                                    <div class="col-5 text-end" id="preview-capital">$0.00</div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-7">Intereses estimados:</div>
                                                    <div class="col-5 text-end" id="preview-intereses">$0.00</div>
                                                </div>
                                                <div class="row fw-bold mt-2">
                                                    <div class="col-7">Total estimado al final:</div>
                                                    <div class="col-5 text-end" id="preview-total">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="mt-4 text-center">
                                                <p class="disclaimer small">Valores referenciales, no son considerados como una oferta formal. La oferta definitiva está sujeta al cumplimiento de las condiciones y políticas referentes a capacidad de pago.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-outline-blue me-2 btn-back" data-prev="1">Atrás</button>
                                <button type="button" class="btn btn-yellow btn-continue" data-next="3">Calcular resultados</button>
                            </div>
                        </div>
                        
                        <!-- Paso 3: Resultados de la simulación -->
                        <div class="step-content" id="step-3">
                            <div class="row">
                                <div class="col-md-12 text-center mb-4">
                                    <h3>Resultado de tu inversión</h3>
                                    <h5 class="">Conoce el rendimiento proyectado de tu inversión</h5>
                                </div>
                            </div>
                            
                            <div class="resultado-container">
                                <!-- Panel de Resumen Principal -->
                                <div class="resultado-principal-panel">
                                    <div class="card rounded-lg shadow-sm">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-6 resultado-monto-final">
                                                    <h5>Tu inversión crecerá hasta</h5>
                                                    <div class="monto-final" id="final-monto">$0.00</div>
                                                    <div class="crecimiento-badge" id="crecimiento-porcentaje">+0%</div>
                                                </div>
                                                <div class="col-md-6 resultado-desglose">
                                                    <div class="desglose-item">
                                                        <div class="desglose-label">Capital inicial:</div>
                                                        <div class="desglose-value" id="final-capital-inicial">$0.00</div>
                                                    </div>
                                                    <div class="desglose-item">
                                                        <div class="desglose-label">Intereses generados:</div>
                                                        <div class="desglose-value" id="final-intereses">$0.00</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Paneles de Información Principal -->
                                <div class="row resultado-info-panels">
                                    <!-- Panel de Detalles de la Inversión -->
                                    <div class="col-md-5 result-info-panels">
                                        <div class="card rounded-lg shadow-sm h-100">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    Detalles de tu inversión
                                                </h5>
                                                <hr>
                                                <div class="detalles-grid">
                                                    <div class="detalle-item">
                                                        <div class="detalle-icon">
                                                            <i class="fas fa-coins"></i>
                                                        </div>
                                                        <div class="detalle-content">
                                                            <div class="detalle-label">Capital invertido</div>
                                                            <div class="detalle-value" id="resultado-capital">$0.00</div>
                                                        </div>
                                                    </div>
                                                    <div class="detalle-item">
                                                        <div class="detalle-icon">
                                                            <i class="fas fa-calendar-alt"></i>
                                                        </div>
                                                        <div class="detalle-content">
                                                            <div class="detalle-label">Plazo</div>
                                                            <div class="detalle-value" id="resultado-plazo">0 meses (0 años)</div>
                                                        </div>
                                                    </div>
                                                    <div class="detalle-item">
                                                        <div class="detalle-icon">
                                                            <i class="fas fa-chart-line"></i>
                                                        </div>
                                                        <div class="detalle-content">
                                                            <div class="detalle-label">Rentabilidad anual</div>
                                                            <div class="detalle-value" id="resultado-rentabilidad">0%</div>
                                                        </div>
                                                    </div>
                                                    <div class="detalle-item">
                                                        <div class="detalle-icon">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </div>
                                                        <div class="detalle-content">
                                                            <div class="detalle-label">Capitalización</div>
                                                            <div class="detalle-value" id="resultado-capitalizacion">No</div>
                                                        </div>
                                                    </div>
                                                    <div class="detalle-item">
                                                        <div class="detalle-icon">
                                                            <i class="fas fa-shield-alt"></i>
                                                        </div>
                                                        <div class="detalle-content">
                                                            <div class="detalle-label">Nivel de riesgo</div>
                                                            <div class="detalle-value" id="resultado-riesgo">Bajo</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Panel de Gráfico -->
                                    <div class="col-md-7 result-info-panels">
                                        <div class="card rounded-lg shadow-sm h-100">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    Evolución de tu inversión
                                                </h5>
                                                <hr>
                                                <div class="chart-container">
                                                    <canvas id="resultadoChart"></canvas>
                                                </div>
                                                <div class="chart-legend">
                                                    <div class="legend-item">
                                                        <span class="legend-color capital-color"></span>
                                                        <span class="legend-text">Capital inicial</span>
                                                    </div>
                                                    <div class="legend-item">
                                                        <span class="legend-color interes-color"></span>
                                                        <span class="legend-text">Intereses generados</span>
                                                    </div>
                                                </div>

                                                <div class="text-center mt-4">
                                                    <button type="button" class="btn btn-outline-blue btn-sm" id="ver-tabla-detalle" data-bs-toggle="modal" data-bs-target="#modalTablaDetalle">
                                                        <i class="fas fa-table me-2"></i>Ver detalle mes a mes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botones de Acción -->
                                <div class="resultado-actions mt-4">
                                    <button type="button" class="btn btn-outline-blue me-3 btn-back" data-prev="2">
                                        <i class="fas fa-arrow-left me-2"></i>Atrás
                                    </button>
                                    <button type="button" class="btn btn-yellow" id="recalcular">
                                        <i class="fas fa-sync me-2"></i>Nueva simulación
                                    </button>
                                </div>
                                
                                <!-- Call-to-Action -->
                                <div class="carta-inversion mt-5">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-9">
                                                    <h4 class="mb-3">¿Te interesa esta inversión?</h4>
                                                    <p>Abre una cuenta en Ahorro Futuro y comienza a invertir hoy mismo para asegurar tu futuro financiero. Nuestros asesores están listos para ayudarte.</p>
                                                </div>
                                                <div class="col-md-3 text-center">
                                                    <a href="{% url 'contacto' %}" class="btn btn-yellow btn-lg">
                                                        <i class="fas fa-chevron-right me-2"></i>Quiero invertir
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="tipo_inversion_id" name="tipo_inversion_id" value="">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal mejorado para tabla de detalle -->
<div class="modal fade" id="modalTablaDetalle" tabindex="-1" aria-labelledby="modalTablaDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content content-modal">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTablaDetalleLabel">
                    <i class="fas fa-calculator me-2"></i>Tabla de Inversión
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Resumen de los datos de la inversión -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h6 class="card-title fw-bold mb-3">Información de la Inversión</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Tipo de Inversión</p>
                                        <p id="modal-tipo-inversion">-</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Monto Invertido</p>
                                        <p id="modal-monto-inversion">-</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Plazo</p>
                                        <p id="modal-plazo-inversion">-</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Tasa de Rentabilidad</p>
                                        <p id="modal-tasa-inversion">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h6 class="card-title fw-bold mb-3">Detalle de la inversión</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Capital invertido:</p>
                                        <p id="modal-capital-invertido">$0.00</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Total de intereses:</p>
                                        <p id="modal-total-intereses">$0.00</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Reinversión de intereses:</p>
                                        <p id="modal-reinversion">No</p>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1 small">Capital final:</p>
                                        <p id="modal-capital-final">$0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de detalle mes a mes -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="modal-tabla-resultados">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Periodo</th>
                                <th class="text-end">Capital</th>
                                <th class="text-end">Interés generado</th>
                                <th class="text-end">Capital final</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se llenarán los resultados dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 modal-litle-section">
                    <p class="text-muted small fst-italic"><i class="fas fa-info-circle me-1"></i>Valores referenciales, estos no constituyen una oferta formal de inversión. La rentabilidad está sujeta a condiciones de mercado y políticas de la entidad.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-blue" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <button type="button" class="btn btn-yellow" id="btn-descargar-detalle">
                    <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<section class="feature-section">
    <div class="container">
        <h2 class="section-title">Beneficios</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa fa-check"></i>
                    </div>
                    <h3 class="feature-title">Rentabilización</h3>
                    <p>Más rentabilidad para tus inversiones.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa fa-usd"></i>
                    </div>
                    <h3 class="feature-title">Monto y Plazo</h3>
                    <p>Opciones de montos y plazos.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <h3 class="feature-title">Recibir intereses</h3>
                    <p>Tú decides cuando quieres recibir los intereses.</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Simulador de Inversión - JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            
            // Variables globales
            let previewChart = null;
            let resultadoChart = null;
            let tipoInversionSeleccionado = null;
            let resultadosCalculados = null;
            
            // Elementos DOM
            const tipoInversionCards = document.querySelectorAll('.tipo-inversion-card');
            const btnContinue = document.querySelectorAll('.btn-continue');
            const btnBack = document.querySelectorAll('.btn-back');
            const stepItems = document.querySelectorAll('.stepper-item');
            const stepContents = document.querySelectorAll('.step-content');
            const plazoSelect = document.getElementById('plazo');
            const montoInversion = document.getElementById('monto_inversion');
            const reinversionCheck = document.getElementById('reinversion_intereses');
            const btnVerTablaDetalle = document.getElementById('ver-tabla-detalle');
            const tablaDetalle = document.querySelector('.tabla-detalle');
            
            // Inicialización de tooltips y toasts
            initializeTooltipsAndToasts();
            
            // Formateador de moneda
            const formatter = new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });
        
            // Función para eliminar formato de moneda
            function unformatMoney(value) {
                if (!value) return '';
                return value.toString().replace(/[^\d.]/g, '');
            }
            
            // Función para formatear valor como moneda
            function formatMoney(value) {
                if (!value) return '';
                const numValue = parseFloat(value);
                if (isNaN(numValue)) return '';
                return formatter.format(numValue);
            }

            function reiniciarSimulador() {
                // Campos relacionados con inversión
                $("#monto_inversion").val('');
                $("#plazo_meses").val('');
                $("#tasa_rentabilidad").val('');
                $("#preview-capital").text('');
                $("#preview-intereses").text('');
                $("#preview-total").text('');
                $("#previewChart").empty();

                // Desactivar checkbox de reinversión
                if (reinversionCheck) {
                    reinversionCheck.checked = false;
                }

                // Limpiar gráficos
                if (previewChart) {
                    previewChart.destroy();
                    previewChart = null;
                }
                
                if (resultadoChart) {
                    resultadoChart.destroy();
                    resultadoChart = null;
                }
                
                // Ocultar tabla de detalle
                if (tablaDetalle) {
                    tablaDetalle.style.display = 'none';
                }
            }
            
            // Evento para seleccionar un tipo de inversión
            tipoInversionCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Quitar selección previa
                    tipoInversionCards.forEach(c => c.classList.remove('selected'));
                    // Seleccionar la tarjeta actual
                    this.classList.add('selected');
                    // Activar botón de continuar
                    document.querySelector('.btn-continue[data-next="2"]').removeAttribute('disabled');
                    // Guardar ID del tipo de inversión seleccionado
                    const tipoId = this.getAttribute('data-id');
                    document.getElementById('tipo_inversion_id').value = tipoId;
                    
                    // Obtener datos detallados del tipo de inversión
                    fetchTipoInversionData(tipoId);
                });
            });
            
            // Eventos para los botones de navegación
            btnContinue.forEach(btn => {
                btn.addEventListener('click', function() {
                    const nextStep = parseInt(this.getAttribute('data-next'));
                    
                    // Validaciones antes de avanzar
                    if (nextStep === 3) {
                        // Validar el formulario antes de calcular
                        if (!validateInversionForm()) {
                            return;
                        }
                        // Calcular resultados
                        calcularResultados();
                    }
                    
                    // Cambiar al siguiente paso
                    goToStep(nextStep);
                });
            });
            
            btnBack.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prevStep = parseInt(this.getAttribute('data-prev'));
                    goToStep(prevStep);
                });
            });
            
            // Evento para recalcular
            const btnRecalcular = document.getElementById('recalcular');
            if (btnRecalcular) {
                btnRecalcular.addEventListener('click', function() {
                    goToStep(1);
                    reiniciarSimulador();
                });
            }
            
            // Eventos para ver tabla de detalle
            if (btnVerTablaDetalle) {
                const btnClone = btnVerTablaDetalle.cloneNode(true);
                btnVerTablaDetalle.parentNode.replaceChild(btnClone, btnVerTablaDetalle);
            }

            // 2. Agregar esta función para llenar el modal cuando se abra
            document.getElementById('modalTablaDetalle').addEventListener('show.bs.modal', function (event) {
                if (!resultadosCalculados) return;
                
                // Llenar información de la inversión
                document.getElementById('modal-tipo-inversion').textContent = document.getElementById('tipo-inversion-seleccionado').textContent;
                document.getElementById('modal-monto-inversion').textContent = formatter.format(resultadosCalculados.capital_inicial);
                document.getElementById('modal-plazo-inversion').textContent = `${resultadosCalculados.plazo_meses} meses (${resultadosCalculados.plazo_anios} años)`;
                document.getElementById('modal-tasa-inversion').textContent = `${resultadosCalculados.rentabilidad_anual}%`;
                
                // Llenar el resumen
                document.getElementById('modal-capital-invertido').textContent = formatter.format(resultadosCalculados.capital_inicial);
                document.getElementById('modal-total-intereses').textContent = formatter.format(resultadosCalculados.interes_total);
                document.getElementById('modal-reinversion').textContent = reinversionCheck.checked ? 'Sí' : 'No';
                document.getElementById('modal-capital-final').textContent = formatter.format(resultadosCalculados.capital_final);
                
                // Llenar la tabla de resultados
                fillDetalleTable('modal-tabla-resultados');
            });
            
            // Eventos para el input de monto de inversión (CORREGIDO)
            if (montoInversion) {
                // INPUT: Solo permitir números y un punto decimal
                montoInversion.addEventListener('input', function (e) {
                    // Mantener la posición del cursor
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const originalLength = this.value.length;
                    
                    // Solo permitir números y un punto decimal
                    let value = this.value;
                    
                    // Remover caracteres no permitidos
                    value = value.replace(/[^0-9.]/g, '');
                    
                    // Asegurarse de que solo haya un punto decimal
                    const puntoPosicion = value.indexOf('.');
                    if (puntoPosicion !== -1) {
                        const despuesPunto = value.substring(puntoPosicion + 1);
                        if (despuesPunto.indexOf('.') !== -1) {
                            value = value.substring(0, puntoPosicion + 1) + 
                                    despuesPunto.replace(/\./g, '');
                        }
                    }
                    
                    this.value = value;
                    
                    // Restaurar posición del cursor ajustada si hubo cambios
                    const diff = value.length - originalLength;
                    if (diff !== 0) {
                        this.selectionStart = start + diff;
                        this.selectionEnd = end + diff;
                    }
                    
                    // Actualizar previsualización con el valor actual SIN formatear
                    updatePreview();
                });

                // FOCUS: eliminar formato al enfocar el campo
                montoInversion.addEventListener('focus', function () {
                    // Obtener el valor numérico sin el símbolo de moneda y otros caracteres no numéricos
                    const valorSinFormato = unformatMoney(this.value);
                    if (parseFloat(valorSinFormato) > 0) {
                        this.value = valorSinFormato;
                    } else {
                        this.value = '';
                    }
                });

                // BLUR: aplicar formato al salir del campo
                montoInversion.addEventListener('blur', function () {
                    const valor = this.value.trim();
                    if (valor) {
                        const numeroLimpio = valor.replace(/[^0-9.]/g, '');
                        if (numeroLimpio) {
                            this.value = formatMoney(numeroLimpio);
                        } else {
                            this.value = '';
                        }
                    }
                    
                    // Actualizar previsualización después de formatear
                    updatePreview();
                });
            }

            // Resto del código se mantiene igual...
            // Evento para cambio en el plazo
            if (plazoSelect) {
                plazoSelect.addEventListener('change', function() {
                    // Evitar recálculos innecesarios si no hay monto ingresado
                    if (montoInversion.value) {
                        updatePreview();
                    }
                });
            }

            // Evento para cambio en la reinversión
            if (reinversionCheck) {
                reinversionCheck.addEventListener('change', function() {
                    // Evitar recálculos innecesarios si no hay monto ingresado
                    if (montoInversion.value) {
                        updatePreview();
                    }
                });
            }
            
            // Función para ir a un paso específico
            function goToStep(step) {
                // Actualizar el stepper
                stepItems.forEach(item => {
                    const itemStep = parseInt(item.getAttribute('data-step'));
                    item.classList.remove('active');
                    item.classList.remove('completed');
                    
                    if (itemStep === step) {
                        item.classList.add('active');
                    } else if (itemStep < step) {
                        item.classList.add('completed');
                    }
                });
                
                // Actualizar contenido visible
                stepContents.forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById('step-' + step).classList.add('active');
            }
            
            // Función para obtener datos detallados del tipo de inversión seleccionado
            function fetchTipoInversionData(tipoId) {
                fetch(`/inversiones/api/tipo-inversion/${tipoId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al obtener datos del tipo de inversión');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            tipoInversionSeleccionado = data.data;
                            setupStep2WithData(tipoInversionSeleccionado);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Error al cargar datos del tipo de inversión',
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al cargar datos del tipo de inversión',
                            confirmButtonColor: '#3085d6'
                        });
                    });
            }
            
            // Función para configurar el paso 2 con los datos obtenidos
            function setupStep2WithData(tipoData) {
                reiniciarSimulador();
                
                // Actualizar nombre del tipo de inversión seleccionado
                document.getElementById('tipo-inversion-seleccionado').textContent = tipoData.nombre;
                
                // Establecer rangos de monto
                document.getElementById('rango_monto').textContent = `Rango: ${formatter.format(tipoData.monto_minimo)} - ${formatter.format(tipoData.monto_maximo)}`;
                
                // Establecer rangos de plazo y llenar select
                document.getElementById('rango_plazo').textContent = `Rango: ${tipoData.plazo_minimo} - ${tipoData.plazo_maximo} meses`;
                
                // Llenar el select de plazos
                fillPlazoSelect(tipoData.plazo_minimo, tipoData.plazo_maximo);
                
                // Actualizar rentabilidad
                const rentabilidadMin = tipoData.rentabilidad_minima;
                const rentabilidadMax = tipoData.rentabilidad_maxima;
                const rentabilidadActual = parseFloat(document.getElementById('resultado-rentabilidad').textContent) || rentabilidadMin;

                // Evitar división por cero
                const porcentajeRelativo = rentabilidadMax > rentabilidadMin
                    ? ((rentabilidadActual - rentabilidadMin) / (rentabilidadMax - rentabilidadMin)) * 100
                    : 0;

                document.getElementById('rentabilidad-min').textContent = `${rentabilidadMin}%`;
                document.getElementById('rentabilidad-max').textContent = `${rentabilidadMax}%`;
                document.getElementById('rentabilidad-fill').style.width = `${porcentajeRelativo}%`;
                
                // Actualizar nivel de riesgo
                const nivelRiesgo = tipoData.riesgo;
                document.getElementById('nivel-riesgo').textContent = nivelRiesgo;
                
                let riskWidth = 0;
                let riskDescription = '';
                let riskColor = '';

                switch(nivelRiesgo) {
                    case 'BAJO':
                        riskWidth = 30;
                        riskColor = '#4caf50'; // verde
                        riskDescription = 'Inversión conservadora con menor rendimiento pero mayor seguridad.';
                        break;
                    case 'MEDIO':
                        riskWidth = 60;
                        riskColor = '#ffeb3b'; // amarillo
                        riskDescription = 'Balance entre rendimiento y seguridad.';
                        break;
                    case 'ALTO':
                        riskWidth = 90;
                        riskColor = '#f44336'; // rojo
                        riskDescription = 'Mayor rentabilidad potencial con mayor volatilidad y riesgo.';
                        break;
                }
                
                const riskLevelEl = document.getElementById('risk-level');
                riskLevelEl.style.width = `${riskWidth}%`;
                riskLevelEl.style.backgroundColor = riskColor;
                document.getElementById('risk-level').style.width = `${riskWidth}%`;
                document.getElementById('risk-description').textContent = riskDescription;
            }
            
            // Función para llenar el select de plazos
            function fillPlazoSelect(min, max) {
                const plazoSelect = document.getElementById("plazo");
                plazoSelect.innerHTML = '<option value="" disabled selected>Selecciona tu plazo</option>';
            
                // Plazos comunes cada 12 meses
                const plazosComunes = [12, 24, 36, 48, 60, 72, 84, 96, 108, 120, 132, 144, 156, 168, 180, 192, 204, 216, 228, 240, 252, 264, 276, 288, 300];
            
                plazosComunes.forEach(meses => {
                    if (meses >= min && meses <= max) {
                        const años = meses / 12;
                        const option = document.createElement('option');
                        option.value = meses;
                        option.textContent = `${años} ${años === 1 ? 'año' : 'años'} (${meses} meses)`;
                        plazoSelect.appendChild(option);
                    }
                });
            }
            
            // Función para validar el formulario de inversión
            function validateInversionForm() {
                if (!tipoInversionSeleccionado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tipo de inversión requerido',
                        text: 'Debe seleccionar un tipo de inversión',
                    });
                    return false;
                }
                
                // Validar monto
                const montoValue = parseFloat(unformatMoney(montoInversion.value));
                
                if (isNaN(montoValue) || montoValue <= 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Monto inválido',
                        text: 'Ingrese un monto válido para la inversión',
                    });
                    montoInversion.focus();
                    return false;
                }
                
                if (montoValue < tipoInversionSeleccionado.monto_minimo || montoValue > tipoInversionSeleccionado.monto_maximo) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Monto fuera de rango',
                        text: `El monto debe estar entre ${formatter.format(tipoInversionSeleccionado.monto_minimo)} y ${formatter.format(tipoInversionSeleccionado.monto_maximo)}`,
                    });
                    montoInversion.focus();
                    return false;
                }
                
                // Validar plazo
                if (!plazoSelect.value) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Plazo requerido',
                        text: 'Debe seleccionar un plazo para la inversión',
                    });
                    plazoSelect.focus();
                    return false;
                }
                
                return true;
            }

            // Función para actualizar la previsualización (MODIFICADA)
            function updatePreview() {
                if (!tipoInversionSeleccionado) return;
                
                // Extracción correcta del valor numérico del monto
                const montoValueStr = unformatMoney(montoInversion.value);
                const montoValue = parseFloat(montoValueStr) || 0;
                
                const plazoValue = parseInt(plazoSelect.value) || 0;
                const reinversionValue = reinversionCheck.checked;
                
                // Actualizar valores en la previsualización con el formato correcto
                document.getElementById('preview-capital').textContent = formatter.format(montoValue);
                
                // Calcular intereses estimados
                if (montoValue > 0 && plazoValue > 0) {
                    // Rentabilidad promedio (usamos el punto medio entre mínimo y máximo)
                    const rentabilidadPromedio = (tipoInversionSeleccionado.rentabilidad_minima + tipoInversionSeleccionado.rentabilidad_maxima) / 2;
                    const tasaMensual = rentabilidadPromedio / 12 / 100;
                    
                    let interesTotal = 0;
                    let montoFinal = montoValue;
                    
                    if (reinversionValue) {
                        // Con capitalización
                        montoFinal = montoValue * Math.pow(1 + tasaMensual, plazoValue);
                        interesTotal = montoFinal - montoValue;
                    } else {
                        // Sin capitalización
                        interesTotal = montoValue * tasaMensual * plazoValue;
                        montoFinal = montoValue + interesTotal;
                    }
                    
                    document.getElementById('preview-intereses').textContent = formatter.format(interesTotal);
                    document.getElementById('preview-total').textContent = formatter.format(montoFinal);
                    
                    // Actualizar gráfico de previsualización
                    updatePreviewChart(montoValue, interesTotal);
                } else {
                    document.getElementById('preview-intereses').textContent = formatter.format(0);
                    document.getElementById('preview-total').textContent = formatter.format(montoValue);
                    
                    // Resetear gráfico
                    updatePreviewChart(montoValue, 0);
                }
            }
                        
            // Función para actualizar el gráfico de previsualización
            function updatePreviewChart(capital, interes) {
                const ctx = document.getElementById('previewChart').getContext('2d');
                
                // Destruir gráfico anterior si existe
                if (previewChart) {
                    previewChart.destroy();
                }
                
                // Crear nuevo gráfico
                previewChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Capital', 'Intereses'],
                        datasets: [{
                            data: [capital, interes],
                            backgroundColor: ['#003366', '#ffdd00'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatter.format(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Función para calcular resultados de la inversión
            function calcularResultados() {
                const tipoInversionId = document.getElementById('tipo_inversion_id').value;
                const montoValue = parseFloat(montoInversion.value.replace(/[^\d.]/g, ''));
                const plazoValue = parseInt(plazoSelect.value);
                const reinversionValue = reinversionCheck.checked;
                
                // Datos para el cálculo
                const data = {
                    tipo_inversion: tipoInversionId,
                    monto_inversion: montoValue,
                    plazo: plazoValue,
                    reinversion_intereses: reinversionValue
                };
                
                // Realizar la petición al servidor
                fetch('/inversiones/api/calcular-inversion/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Error al calcular inversión');
                        });
                    }
                    return response.json();
                })
                .then(response => {
                    if (response.success) {
                        resultadosCalculados = response.data;
                        mostrarResultados(resultadosCalculados);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.error || 'Error al calcular inversión',
                            confirmButtonColor: '#d33'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Error al procesar la solicitud',
                        confirmButtonColor: '#d33'
                    });
                });
            }
            
            // Función para mostrar los resultados calculados
            function mostrarResultados(resultados) {
                // Actualizar sección de resumen principal
                document.getElementById('final-monto').textContent = formatter.format(resultados.capital_final);
                document.getElementById('final-capital-inicial').textContent = formatter.format(resultados.capital_inicial);
                document.getElementById('final-intereses').textContent = formatter.format(resultados.interes_total);
                
                // Calcular porcentaje de crecimiento con 2 decimales
                const crecimientoPorcentaje = ((resultados.capital_final / resultados.capital_inicial) - 1) * 100;
                document.getElementById('crecimiento-porcentaje').textContent = `+${crecimientoPorcentaje.toFixed(2)}%`;
                
                // Actualizar detalles de inversión
                document.getElementById('resultado-capital').textContent = formatter.format(resultados.capital_inicial);
                document.getElementById('resultado-plazo').textContent = `${resultados.plazo_meses} meses (${resultados.plazo_anios} años)`;
                document.getElementById('resultado-rentabilidad').textContent = `${resultados.rentabilidad_anual}%`;
                document.getElementById('resultado-capitalizacion').textContent = reinversionCheck.checked ? 'Sí' : 'No';
                document.getElementById('resultado-riesgo').textContent = resultados.riesgo;
                
                // Aplicar clase de color según nivel de riesgo
                const riesgoElement = document.getElementById('resultado-riesgo');
                riesgoElement.className = '';
                
                switch(resultados.riesgo.toLowerCase()) {
                    case 'bajo':
                        riesgoElement.classList.add('text-success');
                        break;
                    case 'medio':
                        riesgoElement.classList.add('text-warning');
                        break;
                    case 'alto':
                        riesgoElement.classList.add('text-danger');
                        break;
                }
                
                // Llenar tabla de detalle
                fillDetalleTable('tabla-resultados');
                
                // Actualizar gráfico de resultados
                updateResultadoChart(resultados);
                
                // Hacer scroll suave hacia los resultados
                document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            
            // Función mejorada para llenar la tabla de detalle
            // 3. Modificar la función fillDetalleTable para que funcione con cualquier tabla
            function fillDetalleTable(tableId) {
                if (!resultadosCalculados || !resultadosCalculados.resultados_mensuales) return;
                
                const tabla = document.getElementById(tableId);
                if (!tabla) return;
                
                const tablaBody = tabla.querySelector('tbody');
                if (!tablaBody) return;
                
                tablaBody.innerHTML = '';

                const hayCapitalizacion = reinversionCheck.checked;
                
                resultadosCalculados.resultados_mensuales.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    // Alternar color de fondo para mayor legibilidad
                    if (index % 2 === 0) {
                        row.classList.add('table-light');
                    }
                    
                    // Contenido de la fila según si hay capitalización o no
                    if (hayCapitalizacion) {
                        // Con capitalización: mostrar capital inicial, interés y capital final de cada mes
                        row.innerHTML = `
                            <td class="text-center">${item.mes}</td>
                            <td class="text-end">${formatter.format(item.capital_inicial)}</td>
                            <td class="text-end">${formatter.format(item.interes)}</td>
                            <td class="text-end fw-bold">${formatter.format(item.capital_final)}</td>
                        `;
                    } else {
                        // Sin capitalización: mostrar capital constante e interés mensual
                        // Y el capital acumulado hasta ese mes
                        const interesAcumulado = (item.interes * item.mes);
                        const capitalHastaAhora = resultadosCalculados.capital_inicial + interesAcumulado;
                        
                        row.innerHTML = `
                            <td class="text-center">${item.mes}</td>
                            <td class="text-end">${formatter.format(item.capital_inicial)}</td>
                            <td class="text-end">${formatter.format(item.interes)}</td>
                            <td class="text-end fw-bold">${formatter.format(capitalHastaAhora)}</td>
                        `;
                    }
                    
                    tablaBody.appendChild(row);
                });
            }

            // 4. Agregar manejo para el botón de descarga de PDF
            document.getElementById('btn-descargar-detalle').addEventListener('click', function() {
                Swal.fire({
                    title: 'Generando PDF',
                    text: 'Estamos preparando tu documento...',
                    timerProgressBar: true,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        setTimeout(() => {
                            Swal.close();
                            generarPDF();
                        }, 1500);
                    }
                });
            });

            function generarPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuración de colores y estilos
                const colorPrimario = [20, 66, 114]; // Azul Ahorro Futuro
                const colorSecundario = [250, 186, 10]; // Amarillo Ahorro Futuro
                const colorTexto = [60, 60, 60]; // Gris oscuro
                const colorSubtitulo = [100, 100, 100]; // Gris medio
                
                // Función para agregar el membrete
                function agregarMembrete() {
                    // Fondo del membrete
                    doc.setFillColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                    doc.rect(0, 0, doc.internal.pageSize.getWidth(), 35, 'F');
                    
                    // Franja decorativa amarilla
                    doc.setFillColor(colorSecundario[0], colorSecundario[1], colorSecundario[2]);
                    doc.rect(0, 35, doc.internal.pageSize.getWidth(), 5, 'F');
                    
                    // Texto del membrete
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("AHORRO FUTURO", 14, 20);
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text("Institución Financiera", 14, 28);
                    
                    // Fecha en el membrete
                    const fechaActual = new Date().toLocaleDateString();
                    doc.setFontSize(10);
                    doc.text(`Generado: ${fechaActual}`, doc.internal.pageSize.getWidth() - 60, 20);
                }
                
                // Función para agregar pie de página en cada página
                function agregarPieDePagina(pageNumber, pageCount) {
                    // Línea separadora
                    doc.setDrawColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                    doc.setLineWidth(0.5);
                    doc.line(14, doc.internal.pageSize.getHeight() - 20, doc.internal.pageSize.getWidth() - 14, doc.internal.pageSize.getHeight() - 20);
                    
                    // Información de contacto
                    doc.setFontSize(8);
                    doc.setTextColor(colorSubtitulo[0], colorSubtitulo[1], colorSubtitulo[2]);
                    doc.text("Ahorro Futuro • Tel: (01) 234-5678 • www.ahorrofuturo.com", 14, doc.internal.pageSize.getHeight() - 14);
                    
                    // Número de página
                    doc.text(`Página ${pageNumber}`, doc.internal.pageSize.getWidth() - 45, doc.internal.pageSize.getHeight() - 14);
                }
                
                // Agregar membrete
                agregarMembrete();
                
                // Título del documento
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text("TABLA DE INVERSIÓN", doc.internal.pageSize.getWidth() / 2, 50, { align: 'center' });
                
                const startY = 60;
                doc.setDrawColor(240, 240, 240);
                doc.setFillColor(248, 248, 248);
                doc.roundedRect(14, startY, doc.internal.pageSize.getWidth() - 28, 40, 3, 3, 'FD');
                
                // Información de la inversión - Título
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.setFontSize(12);
                doc.text("Información de la Inversión", 20, startY + 10);
                
                // Información de la inversión - Contenido
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                // Obtener valores del simulador
                const tipoInversion = document.getElementById('tipo-inversion-seleccionado').textContent;
                const montoInversion = document.getElementById('preview-capital').textContent;
                const plazoInversion = document.getElementById('resultado-plazo').textContent;
                const rentabilidadAnual = document.getElementById('resultado-rentabilidad').textContent;
                const capitalizacion = document.getElementById('resultado-capitalizacion').textContent;
                const nivelRiesgo = document.getElementById('resultado-riesgo').textContent;
                
                // Columna izquierda
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(colorSubtitulo[0], colorSubtitulo[1], colorSubtitulo[2]);
                doc.text("Tipo de Inversión:", 25, startY + 20);
                doc.text("Capital Inicial:", 25, startY + 30);
                
                // Columna derecha
                doc.text("Plazo:", doc.internal.pageSize.getWidth() / 2 + 10, startY + 20);
                doc.text("Tasa de Rentabilidad:", doc.internal.pageSize.getWidth() / 2 + 10, startY + 30);
                
                // Valores columna izquierda
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                doc.setFont('helvetica', 'bold');
                doc.text(tipoInversion, 65, startY + 20);
                doc.text(montoInversion, 80, startY + 30);
                
                // Valores columna derecha
                doc.text(plazoInversion, doc.internal.pageSize.getWidth() / 2 + 55, startY + 20);
                doc.text(rentabilidadAnual, doc.internal.pageSize.getWidth() / 2 + 70, startY + 30);
                
                // Resumen de la inversión - Contenedor
                const resumenY = startY + 50;
                doc.setDrawColor(240, 240, 240);
                doc.setFillColor(248, 248, 248);
                doc.roundedRect(14, resumenY, doc.internal.pageSize.getWidth() - 28, 40, 3, 3, 'FD');
                
                // Resumen de la inversión - Título
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.setFontSize(12);
                doc.text("Resumen de la Inversión", 20, resumenY + 10);
                
                // Resumen de la inversión - Contenido
                const interesTotal = document.getElementById('final-intereses').textContent;
                const capitalFinal = document.getElementById('final-monto').textContent;
                const crecimientoPorcentaje = document.getElementById('crecimiento-porcentaje').textContent;
                
                // Columna izquierda
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(colorSubtitulo[0], colorSubtitulo[1], colorSubtitulo[2]);
                doc.text("Crecimiento:", 25, resumenY + 20);
                doc.text("Intereses Ganados:", 25, resumenY + 30);
                
                // Columna derecha
                doc.text("Nivel de Riesgo:", doc.internal.pageSize.getWidth() / 2 + 10, resumenY + 20);
                doc.text("Capital Final:", doc.internal.pageSize.getWidth() / 2 + 10, resumenY + 30);
                
                // Valores columna izquierda
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                doc.setFont('helvetica', 'bold');

                doc.setTextColor(40, 80, 80);
                doc.text(crecimientoPorcentaje, 80, resumenY + 20);
                
                doc.text(interesTotal, 80, resumenY + 30);
                
                // Valores columna derecha - Nivel de riesgo con color correspondiente
                let colorRiesgo;
                switch(nivelRiesgo.toLowerCase()) {
                    case 'bajo':
                        colorRiesgo = [40, 167, 69]; // Verde para riesgo bajo
                        break;
                    case 'medio':
                        colorRiesgo = [255, 193, 7]; // Amarillo para riesgo medio
                        break;
                    case 'alto':
                        colorRiesgo = [220, 53, 69]; // Rojo para riesgo alto
                        break;
                    default:
                        colorRiesgo = colorTexto; // Color de texto predeterminado
                }
                
                doc.setTextColor(colorRiesgo[0], colorRiesgo[1], colorRiesgo[2]);
                doc.text(nivelRiesgo, doc.internal.pageSize.getWidth() / 2 + 50, resumenY + 20);
                
                // Capital final con color primario para destacarlo
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.text(capitalFinal, doc.internal.pageSize.getWidth() / 2 + 50, resumenY + 30);
                
                // Tabla de resultados mensuales
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                // Definir columnas según si hay capitalización o no
                const hayCapitalizacion = document.getElementById('resultado-capitalizacion').textContent === 'Sí';
                
                // Preparar los datos de la tabla
                let tableBody = [];
                
                if (resultadosCalculados && resultadosCalculados.resultados_mensuales) {
                    resultadosCalculados.resultados_mensuales.forEach(item => {
                        if (hayCapitalizacion) {
                            tableBody.push([
                                item.mes,
                                formatter.format(item.capital_inicial),
                                formatter.format(item.interes),
                                formatter.format(item.capital_final)
                            ]);
                        } else {
                            const interesAcumulado = (item.interes * item.mes);
                            const capitalHastaAhora = resultadosCalculados.capital_inicial + interesAcumulado;
                            
                            tableBody.push([
                                item.mes,
                                formatter.format(item.capital_inicial),
                                formatter.format(item.interes),
                                formatter.format(capitalHastaAhora)
                            ]);
                        }
                    });
                }

                // Crear la tabla
                doc.autoTable({
                    head: [['Período', 'Capital', 'Interés', 'Capital Acumulado']],
                    body: tableBody,
                    startY: resumenY + 50,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: colorPrimario, 
                        textColor: 255,
                        fontSize: 10,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { halign: 'center' },
                        1: { halign: 'right' },
                        2: { halign: 'right' },
                        3: { halign: 'right' }
                    },
                    styles: { 
                        fontSize: 9,
                        cellPadding: 4
                    },
                    alternateRowStyles: {
                        fillColor: [248, 248, 248]
                    },
                    // Garantizar que la tabla se vea bien en múltiples páginas
                    didDrawPage: function(data) {
                        // Agregar membrete en cada nueva página (excepto la primera)
                        if (data.pageCount > 1 && data.pageNumber > 1) {
                            agregarMembrete();
                        }
                        
                        // Agregar pie de página en cada página
                        agregarPieDePagina(data.pageNumber, data.pagesCount);
                    }
                });
                
                // Agregar disclaimer
                const finalY = doc.lastAutoTable.finalY + 10;
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(colorSubtitulo[0], colorSubtitulo[1], colorSubtitulo[2]);
                // Obtener ancho de página
                const pageWidth = doc.internal.pageSize.getWidth();

                // Primer texto
                const texto1 = "* Valores referenciales, no son considerados como una oferta formal de inversión.";
                const textWidth1 = doc.getTextWidth(texto1);
                const x1 = (pageWidth - textWidth1) / 2;
                doc.text(texto1, x1, finalY);

                // Segundo texto
                const texto2 = "La rentabilidad mostrada está sujeta a condiciones de mercado y puede variar en el tiempo.";
                const textWidth2 = doc.getTextWidth(texto2);
                const x2 = (pageWidth - textWidth2) / 2;
                doc.text(texto2, x2, finalY + 4);
                
                // Agregar pie de página en la primera página
                agregarPieDePagina(1, doc.internal.getNumberOfPages());
                
                // Descargar documento
                const fechaFormatada = new Date().toLocaleDateString().replace(/\//g, '-');
                doc.save(`Inversion-AhorroFuturo-${fechaFormatada}.pdf`);
            }

            // Función mejorada para actualizar el gráfico de resultados
            function updateResultadoChart(resultados) {
                const ctx = document.getElementById('resultadoChart');
                if (!ctx) return;
                
                // Destruir gráfico anterior si existe
                if (resultadoChart) {
                    resultadoChart.destroy();
                }

                const ctxContext = ctx.getContext('2d');
                
                const hayCapitalizacion = reinversionCheck.checked;
                const mesesTotales = resultados.plazo_meses;
                
                // Determinar cuántos puntos mostrar según la duración
                let puntosMostrar = Math.min(12, mesesTotales); // Máximo 12 puntos por defecto
                let intervalo = Math.ceil(mesesTotales / puntosMostrar);
                
                // Preparar datos para el gráfico
                const labels = [];
                const capitalData = [];
                const interesData = [];
                const totalData = [];
                
                if (hayCapitalizacion) {
                    // Con capitalización: mostrar evolución del capital + intereses
                    for (let i = 0; i < resultados.resultados_mensuales.length; i += intervalo) {
                        const item = resultados.resultados_mensuales[i];
                        labels.push(`Mes ${item.mes}`);
                        capitalData.push(resultados.capital_inicial); // Capital inicial es constante
                        interesData.push(item.capital_final - resultados.capital_inicial); // Intereses acumulados
                        totalData.push(item.capital_final); // Total acumulado
                    }
                    
                    // Asegurar que se incluye el último mes
                    const lastItem = resultados.resultados_mensuales[resultados.resultados_mensuales.length - 1];
                    if (!labels.includes(`Mes ${lastItem.mes}`)) {
                        labels.push(`Mes ${lastItem.mes}`);
                        capitalData.push(resultados.capital_inicial);
                        interesData.push(lastItem.capital_final - resultados.capital_inicial);
                        totalData.push(lastItem.capital_final);
                    }
                } else {
                    // Sin capitalización: mostrar capital constante y crecimiento lineal de intereses
                    const interesesPorMes = resultados.interes_total / mesesTotales;
                    
                    for (let i = 0; i <= mesesTotales; i += intervalo) {
                        // Ajustar el último punto para que no exceda el total de meses
                        const mes = Math.min(i, mesesTotales);
                        
                        labels.push(`Mes ${mes}`);
                        capitalData.push(resultados.capital_inicial);
                        interesData.push(interesesPorMes * mes);
                        totalData.push(resultados.capital_inicial + (interesesPorMes * mes));
                    }
                    
                    // Asegurar que el último punto es exactamente el mes final
                    if (!labels.includes(`Mes ${mesesTotales}`)) {
                        labels.push(`Mes ${mesesTotales}`);
                        capitalData.push(resultados.capital_inicial);
                        interesData.push(resultados.interes_total);
                        totalData.push(resultados.capital_final);
                    }
                }
                
                // Crear nuevo gráfico con aspecto mejorado
                resultadoChart = new Chart(ctx, {
                    type: 'line', // Cambiado a gráfico de líneas para mejor visualización de tendencia
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total',
                                data: totalData,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 3,
                                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                fill: true,
                                tension: 0.4, // Curva suavizada
                                order: 0 // Se dibuja primero (fondo)
                            },
                            {
                                label: 'Capital inicial',
                                data: capitalData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                borderDash: hayCapitalizacion ? [5, 5] : [], // Línea punteada si hay capitalización
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                fill: false,
                                order: 2 // Se dibuja al final
                            },
                            {
                                label: 'Intereses',
                                data: interesData,
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(255, 206, 86, 1)',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                fill: false,
                                order: 1 // Se dibuja en medio
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                padding: 15,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw;
                                        return `${label}: ${formatter.format(value)}`;
                                    }
                                }
                            },
                            legend: {
                                display: false // Ocultamos la leyenda predeterminada ya que tenemos nuestra propia leyenda
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.3)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatter.format(value);
                                    },
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Función para inicializar tooltips y toasts
            function initializeTooltipsAndToasts() {
                // Inicializar tooltips de Bootstrap
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Crear contenedor para toasts si no existe
                if (!document.getElementById('toast-container')) {
                    const toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                    document.body.appendChild(toastContainer);
                }
            }
            
            // Función para obtener el valor de una cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Iniciar en el paso 1
            goToStep(1);
        });
    </script>
{% endblock %}